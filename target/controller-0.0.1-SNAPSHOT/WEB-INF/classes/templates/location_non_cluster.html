<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head">
</head>
<body>
	<nav class="navbar navbar-default"
		th:replace="fragments/header :: header"></nav>
	<div class="container">
		<div class="row">
			<div th:switch="${action}">
				<p class="alert alert-success" th:case="'success'"
					th:text="${response}"></p>
				<p class="alert alert-success" th:case="'failed'"
					th:text="${response}"></p>
				<p th:case="*"></p>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12 col-sm-4 col-md-4 search-bar">
				<div class="col-xs-12 col-sm-12 col-md-12 border_box ">
					<h4 style="color: #0e9948;">Location Search</h4>
					<div class="input-group" id="search-group">
						<input type="hidden" name="search_param" value="zip"
							id="search_param"> </input> <input type="text" size="8"
							class="form-control" name="search" id="location-search"
							th:value="${search}" placeholder="Enter a City, State or Zipcode"></input>
						<span class="input-group-btn">
							<button class="btn btn-orange" id="location-search-btn"
								type="submit">
								<span class="glyphicon glyphicon-search"></span>
							</button>
						</span>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-sm-8 col-md-8">
				<div class="col-xs-12 col-md-12">
				<a th:href="@{'/buy/'}"><img th:src="@{'/images/728x90/' + ${ad728x90} + '.png'}"
					class="img-responsive center-block flex-ad" alt="Responsive image" /></a>
			</div>
			</div>
		</div>
		<div class="sidebar"></div>
		<div class="col-xs-12 col-md-12 remove-padding border_box map-holder"
			style="width: 100%;">
			<div class="col-xs-12 col-md-4 pre-scrollable remove-padding">
				<ul class="list-group" style="height: auto; max-height: 400px;">
				</ul>
			</div>
			<div id="map" class="col-xs-12 col-md-8 remove-padding"
				style="width: 66.666%; height: 400px;"></div>
		</div>
		<div class="row">
			<div class="col-xs-12 col-sm-12 col-md-12">
				<div
						class="col-xs-12 col-sm-12 col-md-12 border_box remove-padding">
						<div class="col-xs-12 col-sm-12 col-md-12 special_header">
							Process</div>
						<div class="col-xs-12 col-sm-12 col-md-12 site_sea"
							style="text-align: center;"></div>
						<div class="col-xs-12 col-sm-4 col-md-4">
							<h4 class="site_sea text-center">Quick
								Registration</h4>
							<a th:href="@{'/signup/'}"><img
								th:src="@{/images/registration.svg}"
								src="../images/registration.svg"
								class="img-responsive center-block sm-ad" alt="Responsive image" /></a>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-4">
							<h4 class="site_sea text-center">Choose a
								Location</h4>
							<a th:href="@{'/map/'}"><img th:src="@{/images/location.svg}"
								src="../images/location.svg"
								class="img-responsive center-block sm-ad" alt="Responsive image" /></a>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-4">
							<h4 class="site_sea text-center">Get Results</h4>
							<a th:href="@{'/profile/'}"><img th:src="@{/images/verified.svg}"
								src="../images/verified.svg"
								class="img-responsive center-block sm-ad" alt="Responsive image" /></a>
						</div>
					</div>
			</div>
		</div>
		<script
			src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA46-B4auP9n87XHbzJuFHH8iQwxU3uL24&amp;sensor=false"> </script>
			

	</div>
	<div
		th:replace="fragments/footer :: ${#authorization.expression('isAuthenticated()')} ? 'footer-admin' : 'footer'">&copy;
		2016 Footer</div>
	<script th:inline="javascript">
	    /*<![CDATA[*/
	    
	    function getLocation() {
		    if (navigator.geolocation) {
		        navigator.geolocation.watchPosition(showPosition);
		    } else { 
		        x.innerHTML = "Geolocation is not supported by this browser.";}
		    }
		    
		function showPosition(position) {
		    x.innerHTML="Latitude: " + position.coords.latitude + 
		    "<br>Longitude: " + position.coords.longitude + "<br>Accuracy: " + position.coords.accuracy + "<br>Speed: " + position.coords.speed + "<br>Time: " + position.timestamp;
			
			if(position.coords.accuracy <= 100){
				output.innerHTML = "Accuracy within 100";
			}
		
		}
	    	
	    	function abbrState(input, to){
	    
	    var states = [
	        ['Arizona', 'AZ'],
	        ['Alabama', 'AL'],
	        ['Alaska', 'AK'],
	        ['Arizona', 'AZ'],
	        ['Arkansas', 'AR'],
	        ['California', 'CA'],
	        ['Colorado', 'CO'],
	        ['Connecticut', 'CT'],
	        ['Delaware', 'DE'],
	        ['Florida', 'FL'],
	        ['Georgia', 'GA'],
	        ['Hawaii', 'HI'],
	        ['Idaho', 'ID'],
	        ['Illinois', 'IL'],
	        ['Indiana', 'IN'],
	        ['Iowa', 'IA'],
	        ['Kansas', 'KS'],
	        ['Kentucky', 'KY'],
	        ['Kentucky', 'KY'],
	        ['Louisiana', 'LA'],
	        ['Maine', 'ME'],
	        ['Maryland', 'MD'],
	        ['Massachusetts', 'MA'],
	        ['Michigan', 'MI'],
	        ['Minnesota', 'MN'],
	        ['Mississippi', 'MS'],
	        ['Missouri', 'MO'],
	        ['Montana', 'MT'],
	        ['Nebraska', 'NE'],
	        ['Nevada', 'NV'],
	        ['New Hampshire', 'NH'],
	        ['New Jersey', 'NJ'],
	        ['New Mexico', 'NM'],
	        ['New York', 'NY'],
	        ['North Carolina', 'NC'],
	        ['North Dakota', 'ND'],
	        ['Ohio', 'OH'],
	        ['Oklahoma', 'OK'],
	        ['Oregon', 'OR'],
	        ['Pennsylvania', 'PA'],
	        ['Rhode Island', 'RI'],
	        ['South Carolina', 'SC'],
	        ['South Dakota', 'SD'],
	        ['Tennessee', 'TN'],
	        ['Texas', 'TX'],
	        ['Utah', 'UT'],
	        ['Vermont', 'VT'],
	        ['Virginia', 'VA'],
	        ['Washington', 'WA'],
	        ['West Virginia', 'WV'],
	        ['Wisconsin', 'WI'],
	        ['Wyoming', 'WY'],
	    ];

	    if (to == 'abbr'){
	        input = input.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	        for(i = 0; i < states.length; i++){
	            if(states[i][0] == input){
	                return(states[i][1]);
	            }
	        }    
	    } else if (to == 'name'){
	        input = input.toUpperCase();
	        for(i = 0; i < states.length; i++){
	            if(states[i][1] == input){
	                return(states[i][0]);
	            }
	        }    
	    }
	}
	    
	        var companies = [[${companySize}]];
	        var locations = [];
	        var locationsToAdd = [];
	        var contentString = "";
	        var meLat = 39.762252;
	        var meLong = -75.119511;
	        
	        var markers = [];
	        
	        var _eQuatorialEarthRadius = 6378.1370;
	        var _d2r = (Math.PI / 180.0);

	        function HaversineInM(lat1, long1, lat2, long2)
	        {
	            return (0.621371 * HaversineInKM(lat1, long1, lat2, long2));
	        }

	        function HaversineInKM(lat1, long1, lat2, long2)
	        {
	            var dlong = (long2 - long1) * _d2r;
	            var dlat = (lat2 - lat1) * _d2r;
	            var a = Math.pow(Math.sin(dlat / 2.0), 2.0) + Math.cos(lat1 * _d2r) * Math.cos(lat2 * _d2r) * Math.pow(Math.sin(dlong / 2.0), 2.0);
	            var c = 2.0 * Math.atan2(Math.sqrt(a), Math.sqrt(1.0 - a));
	            var d = _eQuatorialEarthRadius * c;

	            return d;
	        }
	  	  
	    	var infowindow = new google.maps.InfoWindow();

	        var marker, i;
	        setLocationList(meLat, meLong);
	        function setLocationList(latSet, longSet){
	        	$(".list-group-item").detach();
	        	console.log("lat " + latSet + " long " + longSet);
	        	meLat = latSet;
	        	meLong = longSet;
	        	locations = [];
	        	//moveToLocation(meLat, meLong);
	        for(var i=0; i < companies.length; i++){
	        	locationsToAdd = [];
	        	var distance = HaversineInKM(meLat, meLong, companies[i].latitude, companies[i].longitude);
	        	var distance_final = Math.round( distance * 10 ) / 10;
	        	contentString = 
	        	'<div class="col-xs-12 col-md-12 remove-padding" id="content">'+
		        '<div class="col-xs-4 col-md-4 remove-padding"><img src="https://toms-java-blog-demo.s3.amazonaws.com/' + companies[i].logo + '" class="img-responsive company-logo" alt="Responsive image">'+'<div class="distance">'+ distance_final +' miles</div>'+'</div><div class="col-xs-8 col-md-8"><h5 id="firstHeading" class="firstHeading">' + companies[i].companyname + '</h5>'+
		        '<div id="bodyContent">'+
		        '<p class="map-address">' + companies[i].address + '</br>' + companies[i].city + ', ' + companies[i].state + ' ' + companies[i].zipcode + '</p>'+
		        '<a class="location-btn" href="/company/' + companies[i].id + '">'+
		        'Company Page</a> '+
		        '</div>'+
		        '</div>'+
		        '</div>';
	        	locationsToAdd.push(contentString);
		        locationsToAdd.push(companies[i].latitude);
		        locationsToAdd.push(companies[i].longitude);
		        locationsToAdd.push(i);
		        locations.push(locationsToAdd);
	        
		        $(".list-group").append("<button class = 'list-group-item' data-milage='"+ distance_final +"' id='" + locations[i][3] + "' onclick='myClick(" + i + ");' style='padding:10px; cursor:pointer;'>" + locations[i][0] + "</button>");
            }
	        
	        var $wrapper = $('.list-group');

	        $wrapper.find('.list-group-item').sort(function (a, b) {
	            return +a.dataset.milage - +b.dataset.milage;
	        })
	        .appendTo( $wrapper );
	       
	        }
	        
	      function myClick(id){
	         google.maps.event.trigger(markers[id], 'click');
	      }

	      var map;
	  	function initialize()
	  	{
	  		if (window.location.href.indexOf("zip") > -1) { // etc
	  			map = new google.maps.Map(document.getElementById('map'), {
	  		  		center: new google.maps.LatLng(companies[0].latitude,companies[0].longitude),//Setting Initial Position
	  		  		zoom: 12
	  		  	  });
			    }else{
			    	map = new google.maps.Map(document.getElementById('map'), {
		  		  		center: new google.maps.LatLng(39.171861,-96.679129),//Setting Initial Position
		  		  		zoom: 4
		  		  	  });
			   
			    }
	  	  
	  	  for (i = 0; i < locations.length; i++) { 
	          marker = new google.maps.Marker({
	          position: new google.maps.LatLng(locations[i][1], locations[i][2]),
	          map: map
	      	});

	        google.maps.event.addListener(marker, 'click', (function(marker, i) {
	          return function() {
	            infowindow.setContent(locations[i][0]);
	            infowindow.open(map, marker);
	            map.panTo(marker.getPosition());
	            map.setZoom(12);
	          }
	        })(marker, i));
	  	  
	  	  markers.push(marker);
	  	   
	      }
	  		
	  		google.maps.event.addListener(map, 'click', function() {
	            infowindow.close();
	        });
	  		
	  		google.maps.event.addListener(map, 'tilesloaded', function() {
	
	  	  	});
	  		
	  		google.maps.event.addListener(map, 'zoom_changed', function() {
	  		    zoom = true;
	  		});
	  		
	  		function myClick(id){
		  		markers[id].setMap(map);
		      	google.maps.event.trigger(markers[id], 'click');
		      }
	     
	  	}
	  	
	  	function newLocation(newLat,newLng)
	  	{
	  		map.setCenter({
	  			lat : newLat,
	  			lng : newLng
	  		});
	  	}
	  	
	  	function moveToLocation(lat, lng){
	  	    var center = new google.maps.LatLng(lat, lng);
	  	  returnedState = $("#location-search").val();
	  		if (returnedState.length == 2){
	  			map.setZoom(5);
	  		}else{
	  			map.setZoom(8);
	  		}
	  	    //map.setZoom(8);
	  	    map.panTo(center);
	  	}
	  	
	    // Sets the map on all markers in the array.
	    var a = 0;
	      function setMapOnAll(map) {
	    	
	    	a = 0;
	    		for (var i = 0; i < markers.length; i++) {
		        	for(var i = 0;i < companies.length; i++){
		        		var miles = "";
		        		returnedState = $("#location-search").val();
		        		if (returnedState.length == 2){
		        			miles = 250;
		        		}else{
		        			miles = 25;
		        		}
		        		if($("#" + i).attr("data-milage") > miles ){
		        			//console.log(companies[i].state);
		        			markers[i].setMap(map);
		        		}else{
		                    if (a == 0){
		                    	moveToLocation(companies[i].latitude, companies[i].longitude);
		                    	a++;
		                    }
		        		}
		        	}
		        }    		
	      }
	    
	      // Show all on map
	      function showAllOnMap(map) {
		        	for(var i=0;i<companies.length; i++){
		        			markers[i].setMap(map);
		        	}    		
	      }
	   
	      function showAllMarkers() {
	    	  showAllOnMap(map);
		      }
	    
	      // Shows any markers currently in the array.
	      function showMarkers() {
	        setMapOnAll(map);
	      }
	 
	  	 // Removes the markers from the map, but keeps them in the array.
	      function clearMarkers() {
	        setMapOnAll(null);
	      }
	  	
	  	google.maps.event.addDomListener(window, 'load', initialize);
	  
	  	/*
	  	$(document).ready(function ()
	  	{
	  		google.maps.event.trigger(markers[1], 'click');
	  		
	  		for(x = 1; x < locations.length; x++)
	  		{
	  		google.maps.event.addDomListener(document.getElementById(x), 'click', function () {
	      		map.setCenter(new google.maps.LatLng(locations[x][1],locations[x][2]));
	  		});
	  		}
	  		
	  	});
	*/

	    /*]]>*/
		</script>
</body>
</html>